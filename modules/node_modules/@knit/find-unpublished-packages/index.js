/* @flow */

import type { TModules } from '@knit/knit-core';

import readPkg from '@knit/read-pkg';

const needle = require('@knit/needle');
const yarn = require('@knit/yarn-utils');

type TFindUnpublishedPackages = (m: TModules) => Promise<Array<string>>;
const findUnpublishedPackages: TFindUnpublishedPackages = (modules) => (
  Promise.all(modules.map(m => (
    yarn.publishedVersions(m)
    .then(vs => ({ name: m, versions: vs }))
    .catch(() => ({ name: m, versions: [] }))
    )))
      .then(infos => infos.reduce((acc, info) => {
        const pkg = readPkg(info.name, needle.paths);
        return !info.versions.includes(pkg.version)
          ? acc.concat(info.name)
          : acc;
      }, []))
);

export default findUnpublishedPackages;
